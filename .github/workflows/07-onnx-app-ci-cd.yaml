name: 07 - CI/CD for FastApi ONXX inference

on: workflow_dispatch

jobs:
  integration:
    name: continuous-integration
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: 04-using-actions
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install Dependencies
        run: |
          uv sync --group integration
      - name: Run Ruff Check
        run: |
          uv run ruff check . --fix
      - name: Run Ruff Format
        run: |
          uv run ruff format .
      - name: Run Pip Audit
        run: |
          uv run pip-audit --vulnerability-service pypi
      - name: Run PyTest
        run: |
          uv run pytest tests

  deployment:
    name: continuous-deployment
    runs-on: ubuntu-latest
    needs: integration
    if: ${{ success() }} 
    defaults:
      run:
        working-directory: 04-using-actions
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install Dependencies
        run: |
          uv sync --group deployment
      - name: Download model
        run: |
          uv run python main.py --script download
      - name: Export model to onnx
        run: |
          uv run python main.py --script export
      - name: Docker build
        run: |
          rm -rf artifacts/model
          uv run docker build -t polish-sentiment-app-onnx:latest .